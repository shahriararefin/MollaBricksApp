<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Molla Bricks - Add Sale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body data-bs-theme="dark">
    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('customers.index') }}">Molla Bricks App</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('customers.index') }}">Customers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('sales.nagad_khata') }}">Nagad Khata (Sales)</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h2>Add New Sale</h2>
        <form method="POST" action="{{ url_for('sales.add') }}" class="row g-3">
            <div class="col-md-6">
                <h4>Sale Details</h4>
                <div class="mb-3">
                    <label for="date" class="form-label">Date *</label>
                    <input type="date" class="form-control" id="date" name="date" value="{{ today }}" required>
                </div>
                <div class="mb-3">
                    <label for="chalan_no" class="form-label">Chalan No. *</label>
                    <input type="text" class="form-control" id="chalan_no" name="chalan_no" value="{{ next_chalan }}" required>
                </div>
                <div class="mb-3">
                    <label for="vehicle_no" class="form-label">Vehicle No.</label>
                    <input type="text" class="form-control" id="vehicle_no" name="vehicle_no">
                </div>
                <div class="mb-3">
                    <label for="brick_type" class="form-label">Brick Type *</label>
                    <select class="form-select" id="brick_type" name="brick_type" required>
                        {% for type in brick_types %}
                            <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="brick_amount" class="form-label">Brick Amount *</label>
                    <input type="number" class="form-control" id="brick_amount" name="brick_amount" value="0" required>
                </div>
            </div>
            <div class="col-md-6">
                <h4>Customer & Payment</h4>
                <div class="mb-3">
                    <label for="customer_id" class="form-label">Customer *</label>
                    <select class="form-select" id="customer_id" name="customer_id" required onchange="getCustomerBalance()">
                        <option value="" selected disabled>--- Select a Customer ---</option>
                        {% for customer in customers %}
                            <option value="{{ customer[0] }}">{{ customer[1] }}</option>
                        {% endfor %}
                    </select>
                    <div id="balanceDisplay" class="form-text mt-2"></div>
                </div>
                <div class="mb-3">
                    <label for="total_amount" class="form-label">Total Amount (BDT) *</label>
                    <input type="number" step="0.01" class="form-control" id="total_amount" name="total_amount" value="0.0" required>
                </div>
                <div class="mb-3">
                    <label for="paid_amount" class="form-label">Paid Amount (BDT) *</label>
                    <input type="number" step="0.01" class="form-control" id="paid_amount" name="paid_amount" value="0.0" required>
                </div>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Sale</button>
                <a href="{{ url_for('sales.nagad_khata') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
    <script>
        function getCustomerBalance() {
            let customerId = document.getElementById('customer_id').value;
            let balanceDisplay = document.getElementById('balanceDisplay');
            if (!customerId) { balanceDisplay.innerHTML = ''; return; }
            fetch(`/api/customer_balance/${customerId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        balanceDisplay.innerHTML = 'Could not fetch balance.';
                        balanceDisplay.className = 'form-text text-danger';
                    } else {
                        balanceDisplay.innerHTML = `<strong>Current Balance: ${data.balance_str}</strong>`;
                        if (data.balance < 0) { balanceDisplay.className = 'form-text text-danger'; } 
                        else { balanceDisplay.className = 'form-text text-success'; }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    balanceDisplay.innerHTML = 'Error fetching balance.';
                    balanceDisplay.className = 'form-text text-danger';
                });
        }
    </script>
</body>
</html>